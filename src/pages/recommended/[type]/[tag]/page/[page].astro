---
import { getCollection } from "astro:content";

import { getTypeTitle, getTagUrlFragment, getTagName } from "@utils/recommended";

export async function getStaticPaths() {
  const items = await getCollection("recommendations");
  const pageSize = 24;

  const uniqueTypes = [...new Set(items.map((i) => i.data.type))];

  return uniqueTypes.flatMap((type) => {
    const typeItems = items.filter((j) => j.data.type === type);
    const allTags = typeItems.flatMap((j) => j.data.tags ?? []);
    const uniqueTagNames = [...new Set(allTags.map((t) => getTagName(t)))];

    return uniqueTagNames.flatMap((tagName) => {
      const tagItems = typeItems.filter((i) =>
        i.data.tags?.some((t) => getTagName(t) === tagName)
      );
      const totalPages = Math.ceil(tagItems.length / pageSize);

      return Array.from({ length: totalPages }, (_, i) => ({
        params: {
          type: getTypeTitle(type).toLowerCase(),
          tag: getTagUrlFragment(tagName),
          page: (i + 1).toString(),
        },
        props: { type, tag: tagName, page: i + 1 },
      }));
    });
  });
}

const { type, tag, page } = Astro.props;

const typeTitle = getTypeTitle(type);

import RecommendedLayout from "@layouts/Recommended.astro";
---

<RecommendedLayout
  title={`${tag} - Page ${page} | ${typeTitle} | Recommended`}
  description={`Brian D. Adams recommendations for ${typeTitle}`}
  sourceLink="/src/pages/recommended/[type]/[tag]/page/[page].astro"
  type={type}
  tag={tag}
  page={page}
/>